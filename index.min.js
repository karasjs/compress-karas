"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var karas=_interopDefault(require("karas"));require("regenerator-runtime");var cloneDeep=_interopDefault(require("lodash.clonedeep")),isEqual=_interopDefault(require("lodash.isEqual")),get=_interopDefault(require("lodash.get"));function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function asyncGeneratorStep(e,r,t,n,i,a,o){try{var s=e[a](o),l=s.value}catch(e){return void t(e)}s.done?r(l):Promise.resolve(l).then(n,i)}function _asyncToGenerator(s){return function(){var e=this,o=arguments;return new Promise(function(r,t){var n=s.apply(e,o);function i(e){asyncGeneratorStep(n,r,t,i,a,"next",e)}function a(e){asyncGeneratorStep(n,r,t,i,a,"throw",e)}i(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function _objectSpread2(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function compressImage(o){return new Promise(function(e){var r=o.width,t=o.height,n=o.quality,i=o.src,a=new Image;a.onload=function(){e({image:a,width:r,height:t,mimeType:base64MimeType(i),quality:n})},window.navigator&&/(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(window.navigator.userAgent)&&(a.crossOrigin="anonymous"),a.src=i}).then(drawCanvas)}function drawCanvas(l){return new Promise(function(t){var e=l.image,r=l.width,n=l.height,i=l.mimeType,a=l.quality,o=document.createElement("canvas");o.width=r,o.height=n;var s=o.getContext("2d");s.fillStyle="transparent",s.fillRect(0,0,r,n),s.save(),s.drawImage(e,0,0,r,n),s.restore(),o.toBlob&&o.toBlob(function(e){var r=new FileReader;r.readAsDataURL(e),r.onloadend=function(){t(r.result)}},i,a)})}function base64MimeType(e){var r=null;if("string"!=typeof e)return r;var t=e.match(/data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+).*,.*/);return t&&t.length&&(r=t[1]),r}var innerCompressImage=Object.freeze({__proto__:null,default:compressImage}),XOM=karas.reset.XOM,isNil=karas.util.isNil,_karas$abbr=karas.abbr,fullCssProperty=_karas$abbr.fullCssProperty,fullAnimate=_karas$abbr.fullAnimate,fullAnimateOption=_karas$abbr.fullAnimateOption;function equalArr(e,r){if(e.length!==r.length)return!1;for(var t=0,n=e.length;t<n;t++){var i=e[t],a=r[t],o=Array.isArray(i),s=Array.isArray(a);if(o&&s){if(!equalArr(i,a))return!1}else if(o||s)return!1;if(i!==a)return!1}return!0}function equalAnimateValue(e,r){var t=[],n={};Object.keys(e).forEach(function(e){"offset"===e||n.hasOwnProperty(e)||(t.push(e),n[e]=!0)});for(var i=0,a=t.length;i<a;i++){var o=t[i];if(!r.hasOwnProperty(o))return!1;var s=e[o],l=r[o];if(Array.isArray(s)&&Array.isArray(l)){if(!equalArr(e,r))return!1}else{if(Array.isArray(s)||Array.isArray(l))return!1;if(s!==l)return!1}}var u=!0;return Object.keys(r).forEach(function(e){"offset"===e||n.hasOwnProperty(e)||(u=!1)}),u}function isAnimateValueUnavailable(e){return!e||0===e.length||1===e.length&&0===Object.keys(e[0]).length}var numberPrecisionMapper={offset:2,duration:0,delay:0,endDelay:0},defaultCompressOption={image:!1,abbr:!0,duplicate:!0,positionPrecision:2},KarasCompress=function(){function n(e,r){var t;if(_classCallCheck(this,n),"string"==typeof e)try{t=JSON.parse(e)}catch(e){console.error(e)}else"object"===_typeof(e)&&(t=e);if(this.animationJson=t,!this.animationJson||"object"!==_typeof(this.animationJson))throw new Error("init compress error");this.options=_objectSpread2({quality:r&&r.quality||.8,compressImage:r&&r.compressImage,useCanvasCompress:r&&r.useCanvasCompress},r),this.initLibrary()}var e;return _createClass(n,[{key:"compress",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var r,t,n,i,a,o,s,l,u=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=0<u.length&&void 0!==u[0]?u[0]:defaultCompressOption,this.animationJson&&"object"===_typeof(this.animationJson)&&r){e.next=3;break}return e.abrupt("return",this.animationJson);case 3:if(t=r.image,n=r.abbr,i=r.duplicate,a=r.positionPrecision,o=void 0===a?2:a,s=cloneDeep(this.animationJson),this.setPositionPrecision(o),l=[],t)return this.traverseImage(s.library,l),this.traverseImage(s.children,l),e.next=12,Promise.all(l);e.next=12;break;case 12:return this.traverseJson(s,n,i),this.traverseJson(s.library,n,i),e.abrupt("return",s);case 15:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"initLibrary",value:function(){var r=this,e=this.animationJson.library;if(this.libraryIdMapper={},this.libraryMapper={},e&&0!==e.length){var t=0;e.forEach(function(e){r.libraryIdMapper[e.id]=t++,r.libraryMapper[e.id]=e})}}},{key:"setPositionPrecision",value:function(e){var r=0<arguments.length&&void 0!==e?e:0;["width","height","left","top"].forEach(function(e){numberPrecisionMapper[e]=r})}},{key:"traverseImage",value:function(e,p){var f=this;e&&0!==e.length&&e.forEach(function(e){var t,n,i,r=!(!e.libraryId||!e.init),a=!1;if(r){var o=f.libraryMapper[e.libraryId];t=get(e,"init.style.width")||get(o,"props.style.width"),n=get(e,"init.style.height")||get(o,"props.style.height"),i=get(e,"init.src"),a=o&&"img"===o.tagName&&!!i}else t=get(e,"props.style.width"),n=get(e,"props.style.height"),i=get(e,"props.src"),a="img"===e.tagName&&!!i;if(a){var s=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=i,c)return e.next=4,c({width:t,height:n,src:i,quality:u});e.next=5;break;case 4:r=e.sent;case 5:l.src=r;case 6:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}(),l=r?e.init:e.props;if(!l)return;var u=f.options.quality,c=f.options.useCanvasCompress?innerCompressImage:f.options.compressImage;p.push(s())}else e.children&&0<e.children.length&&f.traverseImage(e.children,p)})}},{key:"traverseJson",value:function(e,u,c){var p=this;if(e)if(Array.isArray(e))e.forEach(function(e){p.traverseJson(e,u,c)});else{var r=e.id,f=e.libraryId,y=e.init,m=e.props,h=e.animate,t=e.children,v=!!f;if(h){h.forEach(function(t,e){var r=t.value,n=t.options;if(Object.keys(n).forEach(function(e){if(u){var r=p.compressAnimationOptionName(e),t=p.cutNumber(n[e],numberPrecisionMapper[e]);delete n[e],n[r]=t}}),Object.keys(t).forEach(function(e){if(u){var r=p.compressAnimateName(e);r!==e&&(t[r]=t[e],delete t[e])}}),c){var i=r.length;if(2<i)for(var a=0;a<r.length-2;a++){var o=r[a];if(equalAnimateValue(o,r[a+1]))if(equalAnimateValue(o,r[a+2])){if(a+3===i){r.splice(a+1,1);break}for(var s=a+2,l=s+1;l<i&&equalAnimateValue(o,r[l]);l++)s=l;r.splice(a+1,s-a-1),a+=2}else a++}2===(i=r.length)&&equalAnimateValue(r[0],r[1])&&r.splice(1),(i=r.length)&&(delete r[0].offset,delete r[i-1].offset)}r&&r.forEach(function(e){c&&p.removeDuplicatePropertyInFrame(e,v?y.style:m.style,f),u&&p.compressBezier(e),p.compressCssObject(e,!1,u)}),isAnimateValueUnavailable(r)&&(h[e]=null),isEqual(h[e],h[e-1])&&(h[e]=null)});var n=h.filter(function(e){return!!e});0===n.length?delete e.animate:e.animate=n}isNil(r)||(e.id=this.libraryIdMapper[r]),y&&(this.compressCssObject(y.style,c,u,f),this.removeDuplicatePropertyInLibrary(y,f,"points"),this.removeDuplicatePropertyInLibrary(y,f,"controls"),u&&(y.points&&(y.points=this.cutNumber(y.points)),y.controls&&(y.controls=this.cutNumber(y.controls)))),f&&(e.libraryId=this.compressLibraryId(f)),m&&(this.compressCssObject(m.style,c,u),u&&(m.points&&(m.points=this.cutNumber(m.points)),m.controls&&(m.controls=this.cutNumber(m.controls)))),t&&Array.isArray(t)&&t.forEach(function(e){p.traverseJson(e,u,c)})}}},{key:"compressCssObject",value:function(s,e,r,t){var l=this,u=1<arguments.length&&void 0!==e&&e,c=2<arguments.length&&void 0!==r&&r,p=3<arguments.length?t:void 0;s&&Object.keys(s).forEach(function(e){if(isNil(s[e]))delete s[e];else if(u){var r=l.libraryMapper[p],t=r&&r.props&&r.props.style&&r.props.style[e],n=l.checkDefaultProperty(e,s[e]),i=l.checkDefaultProperty(e,t);!isEqual(s[e],t)&&(!n||p&&!i)||delete s[e]}if(c&&!isNil(s[e])){var a=l.compressCssPropertyName(e),o=l.cutNumber(s[e],numberPrecisionMapper[e]);delete s[e],s[a]=o}})}},{key:"removeDuplicatePropertyInFrame",value:function(r,t,e){var n=this;if(r){var i=get(this.libraryMapper,"".concat(e,".props.style"));Object.keys(r).forEach(function(e){t&&!isNil(t[e])?isEqual(r[e],t[e])&&delete r[e]:i&&!isNil(i[e])?isEqual(r[e],i[e])&&delete i[e]:n.checkDefaultProperty(e,r[e])&&delete r[e]})}}},{key:"removeDuplicatePropertyInLibrary",value:function(e,r,t){var n=get(this.libraryMapper,"".concat(r,".props"));t&&e[t]&&n[t]&&isEqual(e[t],n[t])&&delete e[t]}},{key:"checkDefaultProperty",value:function(e,r){return XOM[e]===r}},{key:"compressCssPropertyName",value:function(e){var r=e.match(/^var-(.*)/);return r&&r[1]?"var-".concat(fullCssProperty[r[1]]||r[1]):fullCssProperty[e]||e}},{key:"compressAnimateName",value:function(e){return fullAnimate[e]||e}},{key:"compressAnimationOptionName",value:function(e){var r=e.match(/^var-(.*)/);return r&&r[1]?"var-".concat(fullAnimateOption[r[1]]||r[1]):fullAnimateOption[e]||e}},{key:"cutNumber",value:function(e,r){var t=this;return Array.isArray(e)&&0<e.length?e.map(function(e){return t.cutNumber(e,r)}):"number"!=typeof e?e:Number(e.toFixed(0<=r?r:4))||0}},{key:"compressBezier",value:function(e){var r=this;if(e&&e.easing){var t=e.easing.match(/\((.*)\)/);if(t&&t[1]){var n=t[1].split(",").map(function(e){return r.cutNumber(e,3)});e.easing="(".concat(n.join(","),")")}}}},{key:"compressLibraryId",value:function(e){return 0<=this.libraryIdMapper[e]?this.libraryIdMapper[e]:e}}]),n}();module.exports=KarasCompress;
//# sourceMappingURL=index.min.js.map
