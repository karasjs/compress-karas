"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var karas=_interopDefault(require("karas"));require("regenerator-runtime");var lodash=require("lodash");function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function asyncGeneratorStep(e,r,t,n,a,o,i){try{var s=e[o](i),u=s.value}catch(e){return void t(e)}s.done?r(u):Promise.resolve(u).then(n,a)}function _asyncToGenerator(s){return function(){var e=this,i=arguments;return new Promise(function(r,t){var n=s.apply(e,i);function a(e){asyncGeneratorStep(n,r,t,a,o,"next",e)}function o(e){asyncGeneratorStep(n,r,t,a,o,"throw",e)}a(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function _objectSpread2(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function compressImage(i){return new Promise(function(e){var r=i.width,t=i.height,n=i.quality,a=i.src,o=new Image;o.onload=function(){e({image:o,width:r,height:t,mimeType:base64MimeType(a),quality:n})},window.navigator&&/(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(window.navigator.userAgent)&&(o.crossOrigin="anonymous"),o.src=a}).then(drawCanvas)}function drawCanvas(u){return new Promise(function(t){var e=u.image,r=u.width,n=u.height,a=u.mimeType,o=u.quality,i=document.createElement("canvas");i.width=r,i.height=n;var s=i.getContext("2d");s.fillStyle="transparent",s.fillRect(0,0,r,n),s.save(),s.drawImage(e,0,0,r,n),s.restore(),i.toBlob&&i.toBlob(function(e){var r=new FileReader;r.readAsDataURL(e),r.onloadend=function(){t(r.result)}},a,o)})}function base64MimeType(e){var r=null;if("string"!=typeof e)return r;var t=e.match(/data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+).*,.*/);return t&&t.length&&(r=t[1]),r}var innerCompressImage=Object.freeze({__proto__:null,default:compressImage}),LEVEL_ENUM={NONE:0,ABBR:1,DUPLICATE:2,ALL:3},level={LEVEL_ENUM:LEVEL_ENUM},XOM=karas.reset.XOM,_karas$abbr=karas.abbr,fullCssProperty=_karas$abbr.fullCssProperty,fullAnimate=_karas$abbr.fullAnimate,fullAnimateOption=_karas$abbr.fullAnimateOption,LEVEL_ENUM$1=level.LEVEL_ENUM;function equalArr(e,r){if(e.length!==r.length)return!1;for(var t=0,n=e.length;t<n;t++){var a=e[t],o=r[t],i=Array.isArray(a),s=Array.isArray(o);if(i&&s){if(!equalArr(a,o))return!1}else if(i||s)return!1;if(a!==o)return!1}return!0}function equalAnimateValue(e,r){var t=[],n={};Object.keys(e).forEach(function(e){"offset"===e||n.hasOwnProperty(e)||(t.push(e),n[e]=!0)});for(var a=0,o=t.length;a<o;a++){var i=t[a];if(!r.hasOwnProperty(i))return!1;var s=e[i],u=r[i];if(Array.isArray(s)&&Array.isArray(u)){if(!equalArr(e,r))return!1}else{if(Array.isArray(s)||Array.isArray(u))return!1;if(s!==u)return!1}}var c=!0;return Object.keys(r).forEach(function(e){"offset"===e||n.hasOwnProperty(e)||(c=!1)}),c}var numberPrecisionMapper={offset:2,duration:0,delay:0,endDelay:0},KarasCompress=function(){function n(e,r){var t;if(_classCallCheck(this,n),"string"==typeof e)try{t=JSON.parse(e)}catch(e){console.error(e)}else"object"===_typeof(e)&&(t=lodash.cloneDeep(e));if(this.animationJson=t,!this.animationJson||"object"!==_typeof(this.animationJson))throw new Error("init compress error");this.options=_objectSpread2({quality:r&&r.quality||.8,compressImage:r&&r.compressImage||innerCompressImage},r)}var t;return _createClass(n,[{key:"compress",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.animationJson&&"object"===_typeof(this.animationJson)&&r!==LEVEL_ENUM$1.NONE){e.next=2;break}return e.abrupt("return",this.animationJson);case 2:return this.setPositionPrecision(t),n=[],this.traverseImage(this.animationJson.children,n),e.next=7,Promise.all(n);case 7:return this.traverseJson(this.animationJson,r),e.abrupt("return",this.animationJson);case 9:case"end":return e.stop()}},e,this)})),function(e,r){return t.apply(this,arguments)})},{key:"setPositionPrecision",value:function(e){var r=0<arguments.length&&void 0!==e?e:0;["width","height","left","top"].forEach(function(e){numberPrecisionMapper[e]=r})}},{key:"traverseImage",value:function(e,a){var o=this;e&&0!==e.length&&e.forEach(function(e){if("img"===e.tagName&&e.props.src){var r=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n({width:r.props.style.width,height:r.props.style.height,src:r.props.src,quality:t});case 2:r.props.src=e.sent;case 3:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}(),t=o.options.quality,n=o.options.compressImage;a.push(r(e))}else e.children&&0<e.children.length&&o.traverseImage(e.children,a)})}},{key:"traverseJson",value:function(e,s){var u=this;if(e){var c=e.props,r=e.animate,t=e.children;if(r&&r.forEach(function(t){var e=t.value,n=t.options;if(Object.keys(n).forEach(function(e){if(s===LEVEL_ENUM$1.ABBR||s===LEVEL_ENUM$1.ALL){var r=u.compressAnimationOptionName(e),t=u.cutNumber(n[e],numberPrecisionMapper[e]);delete n[e],n[r]=t}}),Object.keys(t).forEach(function(e){if(s===LEVEL_ENUM$1.ABBR||s===LEVEL_ENUM$1.ALL){var r=u.compressAnimateName(e);r!==e&&(t[r]=t[e],delete t[e])}}),s===LEVEL_ENUM$1.DUPLICATE||s===LEVEL_ENUM$1.ALL){var r=e.length;if(2<r)for(var a=0;a<e.length-2;a++){var o=e[a];if(equalAnimateValue(o,e[a+1]))if(equalAnimateValue(o,e[a+2])){if(a+3===r){e.splice(a+1,1);break}for(var i=a+3;i<r&&equalAnimateValue(o,e[i]);i++);i===r&&i--,e.splice(a+1,i-a-1),a+=2}else a++}2===(r=e.length)&&equalAnimateValue(e[0],e[1])&&e.splice(1),(r=e.length)&&(delete e[0].offset,delete e[r-1].offset)}e&&e.forEach(function(e){s!==LEVEL_ENUM$1.DUPLICATE&&s!==LEVEL_ENUM$1.ALL||u.removeDuplicatePropertyInFrame(e,c.style),s!==LEVEL_ENUM$1.ABBR&&s!==LEVEL_ENUM$1.ALL||(u.compressBezier(e),u.compressCssObject(e,!1,!0))})}),c){var n=s===LEVEL_ENUM$1.DUPLICATE||s===LEVEL_ENUM$1.ALL,a=s===LEVEL_ENUM$1.ABBR||s===LEVEL_ENUM$1.ALL;this.compressCssObject(c.style,n,a),s!==LEVEL_ENUM$1.ABBR&&s!==LEVEL_ENUM$1.ALL||(c.points&&(c.points=this.cutNumber(c.points)),c.controls&&(c.controls=this.cutNumber(c.controls)))}t&&t.forEach(function(e){u.traverseJson(e,s)})}}},{key:"compressCssObject",value:function(n,e,r){var a=this,o=1<arguments.length&&void 0!==e&&e,i=2<arguments.length&&void 0!==r&&r;n&&Object.keys(n).forEach(function(e){if(karas.util.isNil(n[e]))delete n[e];else if(o&&a.checkDefaultProperty(e,n[e]))delete n[e];else if(i){var r=a.compressCssPropertyName(e),t=a.cutNumber(n[e],numberPrecisionMapper[e]);delete n[e],n[r]=t}})}},{key:"removeDuplicatePropertyInFrame",value:function(r,t){var n=this;r&&Object.keys(r).forEach(function(e){t&&!karas.util.isNil(t[e])?r[e]===t[e]&&delete r[e]:n.checkDefaultProperty(e,r[e])&&delete r[e]})}},{key:"checkDefaultProperty",value:function(e,r){return XOM[e]===r}},{key:"compressCssPropertyName",value:function(e){var r=e.match(/^var-(.*)/);return r&&r[1]?"var-".concat(fullCssProperty[r[1]]||r[1]):fullCssProperty[e]||e}},{key:"compressAnimateName",value:function(e){return fullAnimate[e]||e}},{key:"compressAnimationOptionName",value:function(e){var r=e.match(/^var-(.*)/);return r&&r[1]?"var-".concat(fullAnimateOption[r[1]]||r[1]):fullAnimateOption[e]||e}},{key:"cutNumber",value:function(e,r){var t=this;return Array.isArray(e)&&0<e.length?e.map(function(e){return t.cutNumber(e,r)}):"number"!=typeof e?e:Number(e.toFixed(0<=r?r:4))||0}},{key:"compressBezier",value:function(e){var r=this;if(e&&e.easing){var t=e.easing.match(/\((.*)\)/);if(t&&t[1]){var n=t[1].split(",").map(function(e){return r.cutNumber(e,3)});e.easing="(".concat(n.join(","),")")}}}}]),n}();KarasCompress.LEVEL=LEVEL_ENUM$1,module.exports=KarasCompress;
//# sourceMappingURL=index.min.js.map
