"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var karas=_interopDefault(require("karas"));require("regenerator-runtime");var lodash=require("lodash");function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function asyncGeneratorStep(e,r,t,n,a,i,o){try{var s=e[i](o),u=s.value}catch(e){return void t(e)}s.done?r(u):Promise.resolve(u).then(n,a)}function _asyncToGenerator(s){return function(){var e=this,o=arguments;return new Promise(function(r,t){var n=s.apply(e,o);function a(e){asyncGeneratorStep(n,r,t,a,i,"next",e)}function i(e){asyncGeneratorStep(n,r,t,a,i,"throw",e)}a(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function _objectSpread2(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function compressImage(o){return new Promise(function(e){var r=o.width,t=o.height,n=o.quality,a=o.src,i=new Image;i.onload=function(){e({image:i,width:r,height:t,mimeType:base64MimeType(a),quality:n})},window.navigator&&/(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(window.navigator.userAgent)&&(i.crossOrigin="anonymous"),i.src=a}).then(drawCanvas)}function drawCanvas(u){return new Promise(function(t){var e=u.image,r=u.width,n=u.height,a=u.mimeType,i=u.quality,o=document.createElement("canvas");o.width=r,o.height=n;var s=o.getContext("2d");s.fillStyle="transparent",s.fillRect(0,0,r,n),s.save(),s.drawImage(e,0,0,r,n),s.restore(),o.toBlob&&o.toBlob(function(e){var r=new FileReader;r.readAsDataURL(e),r.onloadend=function(){t(r.result)}},a,i)})}function base64MimeType(e){var r=null;if("string"!=typeof e)return r;var t=e.match(/data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+).*,.*/);return t&&t.length&&(r=t[1]),r}var innerCompressImage=Object.freeze({__proto__:null,default:compressImage}),LEVEL_ENUM={NONE:0,ABBR:1,DUPLICATE:2,ALL:3},level={LEVEL_ENUM:LEVEL_ENUM},XOM=karas.reset.XOM,_karas$abbr=karas.abbr,fullCssProperty=_karas$abbr.fullCssProperty,fullAnimate=_karas$abbr.fullAnimate,fullAnimateOption=_karas$abbr.fullAnimateOption,LEVEL_ENUM$1=level.LEVEL_ENUM;function equalArr(e,r){if(e.length!==r.length)return!1;for(var t=0,n=e.length;t<n;t++){var a=e[t],i=r[t],o=Array.isArray(a),s=Array.isArray(i);if(o&&s){if(!equalArr(a,i))return!1}else if(o||s)return!1;if(a!==i)return!1}return!0}function equalAnimateValue(e,r){var t=[],n={};Object.keys(e).forEach(function(e){"offset"===e||n.hasOwnProperty(e)||(t.push(e),n[e]=!0)});for(var a=0,i=t.length;a<i;a++){var o=t[a];if(!r.hasOwnProperty(o))return!1;var s=e[o],u=r[o];if(Array.isArray(s)&&Array.isArray(u)){if(!equalArr(e,r))return!1}else{if(Array.isArray(s)||Array.isArray(u))return!1;if(s!==u)return!1}}var c=!0;return Object.keys(r).forEach(function(e){"offset"===e||n.hasOwnProperty(e)||(c=!1)}),c}function isAnimateValueUnavailable(e){return!e||0===e.length||1===e.length&&0===Object.keys(e[0]).length}var numberPrecisionMapper={offset:2,duration:0,delay:0,endDelay:0},KarasCompress=function(){function n(e,r){var t;if(_classCallCheck(this,n),"string"==typeof e)try{t=JSON.parse(e)}catch(e){console.error(e)}else"object"===_typeof(e)&&(t=lodash.cloneDeep(e));if(this.animationJson=t,!this.animationJson||"object"!==_typeof(this.animationJson))throw new Error("init compress error");this.options=_objectSpread2({quality:r&&r.quality||.8,compressImage:r&&r.compressImage||innerCompressImage},r)}var t;return _createClass(n,[{key:"compress",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.animationJson&&"object"===_typeof(this.animationJson)&&r!==LEVEL_ENUM$1.NONE){e.next=2;break}return e.abrupt("return",this.animationJson);case 2:return this.setPositionPrecision(t),n=[],this.traverseImage(this.animationJson.children,n),e.next=7,Promise.all(n);case 7:return this.traverseJson(this.animationJson,r),e.abrupt("return",this.animationJson);case 9:case"end":return e.stop()}},e,this)})),function(e,r){return t.apply(this,arguments)})},{key:"setPositionPrecision",value:function(e){var r=0<arguments.length&&void 0!==e?e:0;["width","height","left","top"].forEach(function(e){numberPrecisionMapper[e]=r})}},{key:"traverseImage",value:function(e,a){var i=this;e&&0!==e.length&&e.forEach(function(e){if("img"===e.tagName&&e.props.src){var r=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n({width:r.props.style.width,height:r.props.style.height,src:r.props.src,quality:t});case 2:r.props.src=e.sent;case 3:case"end":return e.stop()}},e)}));return function(e){return r.apply(this,arguments)}}(),t=i.options.quality,n=i.options.compressImage;a.push(r(e))}else e.children&&0<e.children.length&&i.traverseImage(e.children,a)})}},{key:"traverseJson",value:function(e,c){var l=this;if(e){var f=e.props,p=e.animate,r=e.children;if(p){p.forEach(function(t,e){var r=t.value,n=t.options;if(Object.keys(n).forEach(function(e){if(c===LEVEL_ENUM$1.ABBR||c===LEVEL_ENUM$1.ALL){var r=l.compressAnimationOptionName(e),t=l.cutNumber(n[e],numberPrecisionMapper[e]);delete n[e],n[r]=t}}),Object.keys(t).forEach(function(e){if(c===LEVEL_ENUM$1.ABBR||c===LEVEL_ENUM$1.ALL){var r=l.compressAnimateName(e);r!==e&&(t[r]=t[e],delete t[e])}}),c===LEVEL_ENUM$1.DUPLICATE||c===LEVEL_ENUM$1.ALL){var a=r.length;if(2<a)for(var i=0;i<r.length-2;i++){var o=r[i];if(equalAnimateValue(o,r[i+1]))if(equalAnimateValue(o,r[i+2])){if(i+3===a){r.splice(i+1,1);break}for(var s=i+2,u=s+1;u<a&&equalAnimateValue(o,r[u]);u++)s=u;r.splice(i+1,s-i-1),i+=2}else i++}2===(a=r.length)&&equalAnimateValue(r[0],r[1])&&r.splice(1),(a=r.length)&&(delete r[0].offset,delete r[a-1].offset)}r&&r.forEach(function(e){c!==LEVEL_ENUM$1.DUPLICATE&&c!==LEVEL_ENUM$1.ALL||l.removeDuplicatePropertyInFrame(e,f.style),c!==LEVEL_ENUM$1.ABBR&&c!==LEVEL_ENUM$1.ALL||(l.compressBezier(e),l.compressCssObject(e,!1,!0))}),isAnimateValueUnavailable(r)&&(p[e]=null)});var t=p.filter(function(e){return!!e});0===t.length?delete e.animate:e.animate=t}if(f){var n=c===LEVEL_ENUM$1.DUPLICATE||c===LEVEL_ENUM$1.ALL,a=c===LEVEL_ENUM$1.ABBR||c===LEVEL_ENUM$1.ALL;this.compressCssObject(f.style,n,a),c!==LEVEL_ENUM$1.ABBR&&c!==LEVEL_ENUM$1.ALL||(f.points&&(f.points=this.cutNumber(f.points)),f.controls&&(f.controls=this.cutNumber(f.controls)))}r&&r.forEach(function(e){l.traverseJson(e,c)})}}},{key:"compressCssObject",value:function(n,e,r){var a=this,i=1<arguments.length&&void 0!==e&&e,o=2<arguments.length&&void 0!==r&&r;n&&Object.keys(n).forEach(function(e){if(karas.util.isNil(n[e]))delete n[e];else if(i&&a.checkDefaultProperty(e,n[e]))delete n[e];else if(o){var r=a.compressCssPropertyName(e),t=a.cutNumber(n[e],numberPrecisionMapper[e]);delete n[e],n[r]=t}})}},{key:"removeDuplicatePropertyInFrame",value:function(r,t){var n=this;r&&Object.keys(r).forEach(function(e){t&&!karas.util.isNil(t[e])?r[e]===t[e]&&delete r[e]:n.checkDefaultProperty(e,r[e])&&delete r[e]})}},{key:"checkDefaultProperty",value:function(e,r){return XOM[e]===r}},{key:"compressCssPropertyName",value:function(e){var r=e.match(/^var-(.*)/);return r&&r[1]?"var-".concat(fullCssProperty[r[1]]||r[1]):fullCssProperty[e]||e}},{key:"compressAnimateName",value:function(e){return fullAnimate[e]||e}},{key:"compressAnimationOptionName",value:function(e){var r=e.match(/^var-(.*)/);return r&&r[1]?"var-".concat(fullAnimateOption[r[1]]||r[1]):fullAnimateOption[e]||e}},{key:"cutNumber",value:function(e,r){var t=this;return Array.isArray(e)&&0<e.length?e.map(function(e){return t.cutNumber(e,r)}):"number"!=typeof e?e:Number(e.toFixed(0<=r?r:4))||0}},{key:"compressBezier",value:function(e){var r=this;if(e&&e.easing){var t=e.easing.match(/\((.*)\)/);if(t&&t[1]){var n=t[1].split(",").map(function(e){return r.cutNumber(e,3)});e.easing="(".concat(n.join(","),")")}}}}]),n}();KarasCompress.LEVEL=LEVEL_ENUM$1,module.exports=KarasCompress;
//# sourceMappingURL=index.min.js.map
