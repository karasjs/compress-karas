"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var karas=_interopDefault(require("karas"));require("regenerator-runtime");var cloneDeep=_interopDefault(require("lodash.clonedeep")),isEqual=_interopDefault(require("lodash.isEqual")),get=_interopDefault(require("lodash.get"));function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function asyncGeneratorStep(e,r,t,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void t(e)}s.done?r(l):Promise.resolve(l).then(n,a)}function _asyncToGenerator(s){return function(){var e=this,o=arguments;return new Promise(function(r,t){var n=s.apply(e,o);function a(e){asyncGeneratorStep(n,r,t,a,i,"next",e)}function i(e){asyncGeneratorStep(n,r,t,a,i,"throw",e)}a(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,n)}return t}function _objectSpread2(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function compressImage(o){return new Promise(function(e){var r=o.width,t=o.height,n=o.quality,a=o.src,i=new Image;i.onload=function(){e({image:i,width:r,height:t,mimeType:base64MimeType(a),quality:n})},window.navigator&&/(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(window.navigator.userAgent)&&(i.crossOrigin="anonymous"),i.src=a}).then(drawCanvas)}function drawCanvas(l){return new Promise(function(t){var e=l.image,r=l.width,n=l.height,a=l.mimeType,i=l.quality,o=document.createElement("canvas");o.width=r,o.height=n;var s=o.getContext("2d");s.fillStyle="transparent",s.fillRect(0,0,r,n),s.save(),s.drawImage(e,0,0,r,n),s.restore(),o.toBlob&&o.toBlob(function(e){var r=new FileReader;r.readAsDataURL(e),r.onloadend=function(){t(r.result)}},a,i)})}function base64MimeType(e){var r=null;if("string"!=typeof e)return r;var t=e.match(/data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+).*,.*/);return t&&t.length&&(r=t[1]),r}var innerCompressImage=Object.freeze({__proto__:null,default:compressImage}),LEVEL_ENUM={NONE:0,ABBR:1,DUPLICATE:2,ALL:3},level={LEVEL_ENUM:LEVEL_ENUM},XOM=karas.reset.XOM,isNil=karas.util.isNil,_karas$abbr=karas.abbr,fullCssProperty=_karas$abbr.fullCssProperty,fullAnimate=_karas$abbr.fullAnimate,fullAnimateOption=_karas$abbr.fullAnimateOption,LEVEL_ENUM$1=level.LEVEL_ENUM;function equalArr(e,r){if(e.length!==r.length)return!1;for(var t=0,n=e.length;t<n;t++){var a=e[t],i=r[t],o=Array.isArray(a),s=Array.isArray(i);if(o&&s){if(!equalArr(a,i))return!1}else if(o||s)return!1;if(a!==i)return!1}return!0}function equalAnimateValue(e,r){var t=[],n={};Object.keys(e).forEach(function(e){"offset"===e||n.hasOwnProperty(e)||(t.push(e),n[e]=!0)});for(var a=0,i=t.length;a<i;a++){var o=t[a];if(!r.hasOwnProperty(o))return!1;var s=e[o],l=r[o];if(Array.isArray(s)&&Array.isArray(l)){if(!equalArr(e,r))return!1}else{if(Array.isArray(s)||Array.isArray(l))return!1;if(s!==l)return!1}}var u=!0;return Object.keys(r).forEach(function(e){"offset"===e||n.hasOwnProperty(e)||(u=!1)}),u}function isAnimateValueUnavailable(e){return!e||0===e.length||1===e.length&&0===Object.keys(e[0]).length}var numberPrecisionMapper={offset:2,duration:0,delay:0,endDelay:0},KarasCompress=function(){function n(e,r){var t;if(_classCallCheck(this,n),"string"==typeof e)try{t=JSON.parse(e)}catch(e){console.error(e)}else"object"===_typeof(e)&&(t=e);if(this.animationJson=t,!this.animationJson||"object"!==_typeof(this.animationJson))throw new Error("init compress error");this.options=_objectSpread2({quality:r&&r.quality||.8,compressImage:r&&r.compressImage,useCanvasCompress:r&&r.useCanvasCompress},r),this.initLibrary()}var t;return _createClass(n,[{key:"compress",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.animationJson&&"object"===_typeof(this.animationJson)&&r!==LEVEL_ENUM$1.NONE){e.next=2;break}return e.abrupt("return",this.animationJson);case 2:return n=cloneDeep(this.animationJson),this.setPositionPrecision(t),a=[],this.traverseImage(n.library,a),this.traverseImage(n.children,a),e.next=9,Promise.all(a);case 9:return this.traverseJson(n,r),this.traverseJson(n.library,r),e.abrupt("return",n);case 12:case"end":return e.stop()}},e,this)})),function(e,r){return t.apply(this,arguments)})},{key:"initLibrary",value:function(){var r=this,e=this.animationJson.library;if(this.libraryIdMapper={},this.libraryMapper={},e&&0!==e.length){var t=0;e.forEach(function(e){r.libraryIdMapper[e.id]=t++,r.libraryMapper[e.id]=e})}}},{key:"setPositionPrecision",value:function(e){var r=0<arguments.length&&void 0!==e?e:0;["width","height","left","top"].forEach(function(e){numberPrecisionMapper[e]=r})}},{key:"traverseImage",value:function(e,p){var f=this;e&&0!==e.length&&e.forEach(function(e){var t,n,a,r=!(!e.libraryId||!e.init),i=!1;if(r){var o=f.libraryMapper[e.libraryId];t=get(e,"init.style.width")||get(o,"props.style.width"),n=get(e,"init.style.height")||get(o,"props.style.height"),a=get(e,"init.src"),i=o&&"img"===o.tagName&&!!a}else t=get(e,"props.style.width"),n=get(e,"props.style.height"),a=get(e,"props.src"),i="img"===e.tagName&&!!a;if(i){var s=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a,c)return e.next=4,c({width:t,height:n,src:a,quality:u});e.next=5;break;case 4:r=e.sent;case 5:l.src=r;case 6:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}(),l=r?e.init:e.props;if(!l)return;var u=f.options.quality,c=f.options.useCanvasCompress?innerCompressImage:f.options.compressImage;p.push(s())}else e.children&&0<e.children.length&&f.traverseImage(e.children,p)})}},{key:"traverseJson",value:function(e,u){var c=this;if(e)if(Array.isArray(e))e.forEach(function(e){c.traverseJson(e,u)});else{var r=e.id,p=e.libraryId,f=e.init,y=e.props,m=e.animate,t=e.children,h=!!p;if(m){m.forEach(function(t,e){var r=t.value,n=t.options;if(Object.keys(n).forEach(function(e){if(u===LEVEL_ENUM$1.ABBR||u===LEVEL_ENUM$1.ALL){var r=c.compressAnimationOptionName(e),t=c.cutNumber(n[e],numberPrecisionMapper[e]);delete n[e],n[r]=t}}),Object.keys(t).forEach(function(e){if(u===LEVEL_ENUM$1.ABBR||u===LEVEL_ENUM$1.ALL){var r=c.compressAnimateName(e);r!==e&&(t[r]=t[e],delete t[e])}}),u===LEVEL_ENUM$1.DUPLICATE||u===LEVEL_ENUM$1.ALL){var a=r.length;if(2<a)for(var i=0;i<r.length-2;i++){var o=r[i];if(equalAnimateValue(o,r[i+1]))if(equalAnimateValue(o,r[i+2])){if(i+3===a){r.splice(i+1,1);break}for(var s=i+2,l=s+1;l<a&&equalAnimateValue(o,r[l]);l++)s=l;r.splice(i+1,s-i-1),i+=2}else i++}2===(a=r.length)&&equalAnimateValue(r[0],r[1])&&r.splice(1),(a=r.length)&&(delete r[0].offset,delete r[a-1].offset)}r&&r.forEach(function(e){u!==LEVEL_ENUM$1.DUPLICATE&&u!==LEVEL_ENUM$1.ALL||c.removeDuplicatePropertyInFrame(e,h?f.style:y.style,p),u!==LEVEL_ENUM$1.ABBR&&u!==LEVEL_ENUM$1.ALL||(c.compressBezier(e),c.compressCssObject(e,!1,!0))}),isAnimateValueUnavailable(r)&&(m[e]=null),isEqual(m[e],m[e-1])&&(m[e]=null)});var n=m.filter(function(e){return!!e});0===n.length?delete e.animate:e.animate=n}if(isNil(r)||(e.id=this.libraryIdMapper[r]),f){var a=u===LEVEL_ENUM$1.DUPLICATE||u===LEVEL_ENUM$1.ALL,i=u===LEVEL_ENUM$1.ABBR||u===LEVEL_ENUM$1.ALL;this.compressCssObject(f.style,a,i,p),this.removeDuplicatePropertyInLibrary(f,p,"points"),this.removeDuplicatePropertyInLibrary(f,p,"controls"),i&&(f.points&&(f.points=this.cutNumber(f.points)),f.controls&&(f.controls=this.cutNumber(f.controls)))}if(p&&(e.libraryId=this.compressLibraryId(p)),y){var o=u===LEVEL_ENUM$1.DUPLICATE||u===LEVEL_ENUM$1.ALL,s=u===LEVEL_ENUM$1.ABBR||u===LEVEL_ENUM$1.ALL;this.compressCssObject(y.style,o,s),s&&(y.points&&(y.points=this.cutNumber(y.points)),y.controls&&(y.controls=this.cutNumber(y.controls)))}t&&Array.isArray(t)&&t.forEach(function(e){c.traverseJson(e,u)})}}},{key:"compressCssObject",value:function(s,e,r,t){var l=this,u=1<arguments.length&&void 0!==e&&e,c=2<arguments.length&&void 0!==r&&r,p=3<arguments.length?t:void 0;s&&Object.keys(s).forEach(function(e){if(isNil(s[e]))delete s[e];else if(u){var r=l.libraryMapper[p],t=r&&r.props&&r.props.style&&r.props.style[e],n=l.checkDefaultProperty(e,s[e]),a=l.checkDefaultProperty(e,t);!isEqual(s[e],t)&&(!n||p&&!a)||delete s[e]}if(c&&!isNil(s[e])){var i=l.compressCssPropertyName(e),o=l.cutNumber(s[e],numberPrecisionMapper[e]);delete s[e],s[i]=o}})}},{key:"removeDuplicatePropertyInFrame",value:function(r,t,e){var n=this;if(r){var a=get(this.libraryMapper,"".concat(e,".props.style"));console.log(r,a,t),Object.keys(r).forEach(function(e){t&&!isNil(t[e])?isEqual(r[e],t[e])&&delete r[e]:a&&!isNil(a[e])?isEqual(r[e],a[e])&&delete a[e]:n.checkDefaultProperty(e,r[e])&&delete r[e]})}}},{key:"removeDuplicatePropertyInLibrary",value:function(e,r,t){var n=get(this.libraryMapper,"".concat(r,".props"));t&&e[t]&&n[t]&&isEqual(e[t],n[t])&&delete e[t]}},{key:"checkDefaultProperty",value:function(e,r){return XOM[e]===r}},{key:"compressCssPropertyName",value:function(e){var r=e.match(/^var-(.*)/);return r&&r[1]?"var-".concat(fullCssProperty[r[1]]||r[1]):fullCssProperty[e]||e}},{key:"compressAnimateName",value:function(e){return fullAnimate[e]||e}},{key:"compressAnimationOptionName",value:function(e){var r=e.match(/^var-(.*)/);return r&&r[1]?"var-".concat(fullAnimateOption[r[1]]||r[1]):fullAnimateOption[e]||e}},{key:"cutNumber",value:function(e,r){var t=this;return Array.isArray(e)&&0<e.length?e.map(function(e){return t.cutNumber(e,r)}):"number"!=typeof e?e:Number(e.toFixed(0<=r?r:4))||0}},{key:"compressBezier",value:function(e){var r=this;if(e&&e.easing){var t=e.easing.match(/\((.*)\)/);if(t&&t[1]){var n=t[1].split(",").map(function(e){return r.cutNumber(e,3)});e.easing="(".concat(n.join(","),")")}}}},{key:"compressLibraryId",value:function(e){return 0<=this.libraryIdMapper[e]?this.libraryIdMapper[e]:e}}]),n}();KarasCompress.LEVEL=LEVEL_ENUM$1,module.exports=KarasCompress;
//# sourceMappingURL=index.min.js.map
