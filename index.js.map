{"version":3,"file":"index.js","sources":["src/compressImage.js","src/level.js","src/index.js"],"sourcesContent":["function compressImage (imageConfig) {\n  return new Promise(resolve => {\n    const {\n      width,\n      height,\n      quality,\n      src,\n    } = imageConfig;\n    const image = new Image();\n    image.onload = () => {\n      resolve({\n        image,\n        width,\n        height,\n        mimeType: base64MimeType(src),\n        quality,\n      });\n    };\n    if (window.navigator && /(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(window.navigator.userAgent)) {\n      // Fix the `The operation is insecure` error (#57)\n      image.crossOrigin = 'anonymous';\n    }\n    image.src = src;\n  }).then(drawCanvas);\n}\n\nfunction drawCanvas(config) {\n  return new Promise(resolve => {\n    const { image, width, height, mimeType, quality } = config;\n    const canvas = document.createElement('canvas');\n    canvas.width = width;\n    canvas.height = height;\n    const context = canvas.getContext('2d');\n    context.fillStyle = 'transparent';\n    context.fillRect(0, 0, width, height);\n    context.save();\n    context.drawImage(image, 0, 0, width, height);\n    context.restore();\n    if (canvas.toBlob) {\n      canvas.toBlob(blob => {\n        const reader = new FileReader();\n        reader.readAsDataURL(blob);\n        reader.onloadend = function() {\n          resolve(reader.result);\n        }\n      }, mimeType, quality);\n    }\n  });\n}\n\nfunction base64MimeType(encoded) {\n  let result = null;\n  if (typeof encoded !== 'string') {\n    return result;\n  }\n  let mime = encoded.match(/data:([a-zA-Z0-9]+\\/[a-zA-Z0-9-.+]+).*,.*/);\n  if (mime && mime.length) {\n    result = mime[1];\n  }\n  return result;\n}\n\nexport default compressImage;\n","const LEVEL_ENUM = {\n  NONE: 0,\n  ABBR: 1,\n  DUPLICATE: 2,\n  ALL: 3,\n};\n\nexport default {\n  LEVEL_ENUM,\n};\n","/**\n * 参考lottie-compress，压缩包括\n *  数字精度压缩\n *  css属性名压缩\n *  移除默认属性\n *  图片压缩\n *\n */\nimport karas from 'karas';\nimport 'regenerator-runtime';\nimport { cloneDeep } from 'lodash';\n\nimport * as innerCompressImage from './compressImage';\nimport level from './level';\n\nconst { XOM } = karas.reset;\nconst { fullCssProperty, fullAnimate, fullAnimateOption } = karas.abbr;\nconst { LEVEL_ENUM } = level;\n\nfunction equalArr(a, b) {\n  if(a.length !== b.length) {\n    return false;\n  }\n  for(let i = 0, len = a.length; i < len; i++) {\n    let ai = a[i];\n    let bi = b[i];\n    let isArrayA = Array.isArray(ai);\n    let isArrayB = Array.isArray(bi);\n    if(isArrayA && isArrayB) {\n      if(!equalArr(ai, bi)) {\n        return false;\n      }\n    }\n    else if(isArrayA || isArrayB) {\n      return false;\n    }\n    if(ai !== bi) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction equalAnimateValue(a, b) {\n  let keyList = [];\n  let keyHash = {};\n  Object.keys(a).forEach(k => {\n    if(k !== 'offset' && !keyHash.hasOwnProperty(k)) {\n      keyList.push(k);\n      keyHash[k] = true;\n    }\n  });\n  for(let i = 0, len = keyList.length; i < len; i++) {\n    let k = keyList[i];\n    if(b.hasOwnProperty(k)) {\n      let va = a[k];\n      let vb = b[k];\n      if(Array.isArray(va) && Array.isArray(vb)) {\n        if(!equalArr(a, b)) {\n          return false;\n        }\n      }\n      else if(Array.isArray(va) || Array.isArray(vb)) {\n        // 异常情况\n        return false;\n      }\n      else if(va !== vb) {\n        return false;\n      }\n    }\n    else {\n      return false;\n    }\n  }\n  let res = true;\n  Object.keys(b).forEach(k => {\n    if(k !== 'offset' && !keyHash.hasOwnProperty(k)) {\n      res = false;\n    }\n  });\n  return res;\n}\n\nfunction isAnimateValueUnavailable(value) {\n  return !value || value.length === 0 || value.length === 1 && Object.keys(value[0]).length === 0;\n}\n\nconst numberPrecisionMapper = {\n  offset: 2,\n  duration: 0,\n  delay: 0,\n  endDelay: 0,\n};\n\nclass KarasCompress {\n  constructor(json, options) {\n    let animationJson;\n    if(typeof json === 'string') {\n      try {\n        animationJson = JSON.parse(json);\n      } catch(error) {\n        console.error(error);\n      }\n    }\n    else if(typeof json === 'object') {\n      animationJson = cloneDeep(json);\n    }\n    this.animationJson = animationJson;\n    if(!(this.animationJson && typeof this.animationJson === 'object')) {\n      throw new Error('init compress error');\n    }\n    this.options = {\n      quality: options && options.quality || 0.8,\n      compressImage: options && options.compressImage || innerCompressImage,\n      ...options,\n    };\n  }\n\n  async compress(level, positionPrecision) {\n    if(!this.animationJson || typeof this.animationJson !== 'object' || level === LEVEL_ENUM.NONE) {\n      return this.animationJson;\n    }\n    this.setPositionPrecision(positionPrecision);\n    let imagesPromise = [];\n    this.traverseImage(this.animationJson.children, imagesPromise);\n    await Promise.all(imagesPromise);\n    this.traverseJson(this.animationJson, level);\n    return this.animationJson;\n  }\n\n  setPositionPrecision(value = 0) {\n    ['width', 'height', 'left', 'top'].forEach(key => {\n      numberPrecisionMapper[key] = value;\n    });\n  }\n  traverseImage(children, promiseList) {\n    if(!children || children.length === 0) {\n      return;\n    }\n    children.forEach(item => {\n      if(item.tagName === 'img' && item.props.src) {\n        const quality = this.options.quality;\n        const compressImage = this.options.compressImage;\n        async function asyncCompressImage(item) {\n          item.props.src = await compressImage({\n            width: item.props.style.width,\n            height: item.props.style.height,\n            src: item.props.src,\n            quality,\n          });\n        }\n\n        promiseList.push(asyncCompressImage(item));\n      }\n      else if(item.children && item.children.length > 0) {\n        this.traverseImage(item.children, promiseList);\n      }\n    });\n  }\n\n  traverseJson(item, level) {\n    if(!item) {\n      return;\n    }\n    let { props, animate, children } = item;\n    if(animate) {\n      animate.forEach((animateItem, index) => {\n        let { value, options } = animateItem;\n        Object.keys(options).forEach(item => {\n          if(level === LEVEL_ENUM.ABBR || level === LEVEL_ENUM.ALL) {\n            let shortOptionName = this.compressAnimationOptionName(item);\n            let fixedOptionValue = this.cutNumber(options[item], numberPrecisionMapper[item]);\n            delete options[item];\n            options[shortOptionName] = fixedOptionValue;\n          }\n        });\n        Object.keys(animateItem).forEach(item => {\n          if(level === LEVEL_ENUM.ABBR || level === LEVEL_ENUM.ALL) {\n            let shortName = this.compressAnimateName(item);\n            if(shortName !== item) {\n              animateItem[shortName] = animateItem[item];\n              delete animateItem[item];\n            }\n          }\n        });\n        if(level === LEVEL_ENUM.DUPLICATE || level === LEVEL_ENUM.ALL) {\n          let len = value.length;\n          // 去除重复帧，寻找和当前帧样式相同的帧，当跨度>=3时，删除中间的，当跨度2且总长2时保留1个\n          if(len > 2) {\n            for(let i = 0; i < value.length - 2; i++) {\n              let start = value[i];\n              if(equalAnimateValue(start, value[i + 1])) {\n                if(equalAnimateValue(start, value[i + 2])) {\n                  // 直接和最后相等\n                  if(i + 3 === len) {\n                    value.splice(i + 1, 1);\n                    break;\n                  }\n                  else {\n                    let lastEqualIndex = i + 2;\n                    let j = lastEqualIndex + 1;\n                    // 找到不相等的那个索引\n                    for(; j < len; j++) {\n                      if(!equalAnimateValue(start, value[j])) {\n                        break;\n                      }\n                      lastEqualIndex = j;\n                    }\n                    value.splice(i + 1, lastEqualIndex - i - 1);\n                  }\n                  i += 2;\n                }\n                else {\n                  i++;\n                }\n              }\n            }\n          }\n          len = value.length;\n          // 只有2个时重复可去除一个，多个时上面操作可能会变成只有2个情况\n          if(len === 2) {\n            if(equalAnimateValue(value[0], value[1])) {\n              value.splice(1);\n            }\n          }\n          len = value.length;\n          // 去除首尾offset\n          if(len) {\n            delete value[0].offset;\n            delete value[len - 1].offset;\n          }\n        }\n        value && value.forEach(item => {\n          if (level === LEVEL_ENUM.DUPLICATE || level === LEVEL_ENUM.ALL) {\n            this.removeDuplicatePropertyInFrame(item, props.style);\n          }\n          if(level === LEVEL_ENUM.ABBR || level === LEVEL_ENUM.ALL) {\n            this.compressBezier(item);\n            this.compressCssObject(item, false, true);\n          }\n        });\n        // 经过处理之后animateItem的value是否只有一个空对象，如果是，则移除整个animateItem\n        if (isAnimateValueUnavailable(value)) {\n          animate[index] = null;\n        }\n      });\n      const filterAnimate = animate.filter(item => !!item);\n      if (filterAnimate.length === 0) {\n        delete item.animate;\n      } else {\n        item.animate = filterAnimate;\n      }\n    }\n    if(props) {\n      // 压缩props\n      const canDeleteDefaultProperty = level === LEVEL_ENUM.DUPLICATE || level === LEVEL_ENUM.ALL;\n      const canAbbr = level === LEVEL_ENUM.ABBR || level === LEVEL_ENUM.ALL;\n      this.compressCssObject(props.style, canDeleteDefaultProperty, canAbbr);\n      if(level === LEVEL_ENUM.ABBR || level === LEVEL_ENUM.ALL) {\n        if (props.points) props.points = this.cutNumber(props.points);\n        if (props.controls) props.controls = this.cutNumber(props.controls);\n      }\n    }\n    if(children) {\n      children.forEach(item => {\n        this.traverseJson(item, level);\n      });\n    }\n  }\n\n  compressCssObject(cssObj, canDeleteDefaultProperty = false, canAbbr = false) {\n    if(!cssObj) {\n      return;\n    }\n    Object.keys(cssObj).forEach(propertyName => {\n      if (karas.util.isNil(cssObj[propertyName])) {\n        // 删除空值\n        delete cssObj[propertyName];\n      } else if(canDeleteDefaultProperty && this.checkDefaultProperty(propertyName, cssObj[propertyName])) {\n        // 检查默认值\n        delete cssObj[propertyName];\n      } else if (canAbbr) {\n        let shortPropertyName = this.compressCssPropertyName(propertyName);\n        let fixedPropertyValue = this.cutNumber(cssObj[propertyName], numberPrecisionMapper[propertyName]);\n        delete cssObj[propertyName];\n        cssObj[shortPropertyName] = fixedPropertyValue;\n      }\n    });\n  }\n\n  // 移除每帧中属性\n  // 1. 与style重复，则删除\n  // 2. style没有，判断是否为默认属性值，如果是则删除\n  removeDuplicatePropertyInFrame(frame, style) {\n    if (!frame) return;\n    Object.keys(frame).forEach(propertyName => {\n      if (style && !karas.util.isNil(style[propertyName])) {\n        // style重复\n        if (frame[propertyName] === style[propertyName]) {\n          delete frame[propertyName];\n        }\n      } else {\n        // 判断是否为默认属性值\n        if (this.checkDefaultProperty(propertyName, frame[propertyName])) {\n          delete frame[propertyName];\n        }\n      }\n    });\n  }\n\n  checkDefaultProperty(k, v) {\n    return XOM[k] === v;\n  }\n\n  compressCssPropertyName(propertyName) {\n    const matches = propertyName.match(/^var-(.*)/);\n    if (matches && matches[1]) {\n      return `var-${fullCssProperty[matches[1]] || matches[1]}`;\n    }\n    return fullCssProperty[propertyName] || propertyName;\n  }\n\n  compressAnimateName(itemName) {\n    return fullAnimate[itemName] || itemName;\n  }\n\n  compressAnimationOptionName(optionName) {\n    const matches = optionName.match(/^var-(.*)/);\n    if (matches && matches[1]) {\n      return `var-${fullAnimateOption[matches[1]] || matches[1]}`;\n    }\n    return fullAnimateOption[optionName] || optionName;\n  }\n\n  cutNumber(propertyValue, n) {\n    if(Array.isArray(propertyValue) && propertyValue.length > 0) {\n      // 数组继续递归\n      return propertyValue.map(v => this.cutNumber(v, n));\n    }\n    else if(typeof propertyValue !== 'number') {\n      // 如果不是数字则立即返回原值\n      return propertyValue;\n    }\n    return Number(propertyValue.toFixed(n >= 0 ? n : 4)) || 0;\n  }\n\n  compressBezier(item) {\n    if (!item || !item.easing) return;\n    const matches = item.easing.match(/\\((.*)\\)/);\n    if (matches && matches[1]) {\n      const controls = matches[1].split(',');\n      const fixedControls = controls.map(item => this.cutNumber(item, 3));\n      item.easing = `(${fixedControls.join(',')})`;\n    }\n  }\n}\n\nKarasCompress.LEVEL = LEVEL_ENUM;\nexport default KarasCompress;\n\n\n\n\n\n"],"names":["compressImage","imageConfig","Promise","resolve","width","height","quality","src","image","Image","onload","mimeType","base64MimeType","window","navigator","test","userAgent","crossOrigin","then","drawCanvas","config","canvas","document","createElement","context","getContext","fillStyle","fillRect","save","drawImage","restore","toBlob","blob","reader","FileReader","readAsDataURL","onloadend","result","encoded","mime","match","length","LEVEL_ENUM","NONE","ABBR","DUPLICATE","ALL","XOM","karas","reset","abbr","fullCssProperty","fullAnimate","fullAnimateOption","level","equalArr","a","b","i","len","ai","bi","isArrayA","Array","isArray","isArrayB","equalAnimateValue","keyList","keyHash","Object","keys","forEach","k","hasOwnProperty","push","va","vb","res","isAnimateValueUnavailable","value","numberPrecisionMapper","offset","duration","delay","endDelay","KarasCompress","json","options","animationJson","JSON","parse","error","console","cloneDeep","Error","innerCompressImage","positionPrecision","setPositionPrecision","imagesPromise","traverseImage","children","all","traverseJson","key","promiseList","item","tagName","props","asyncCompressImage","style","animate","animateItem","index","shortOptionName","compressAnimationOptionName","fixedOptionValue","cutNumber","shortName","compressAnimateName","start","splice","lastEqualIndex","j","removeDuplicatePropertyInFrame","compressBezier","compressCssObject","filterAnimate","filter","canDeleteDefaultProperty","canAbbr","points","controls","cssObj","propertyName","util","isNil","checkDefaultProperty","shortPropertyName","compressCssPropertyName","fixedPropertyValue","frame","v","matches","itemName","optionName","propertyValue","n","map","Number","toFixed","easing","split","fixedControls","join","LEVEL"],"mappings":"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"}